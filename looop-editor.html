<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="editor-code/editor-code.html">
<link rel="import" href="editor-stage/editor-stage.html">

<dom-module id="looop-editor">
    <style>
        #editor-stage {
            display: block;
        }
    </style>
    <template>
        <app-location route="{{route}}" use-hash-as-path></app-location>

        <app-route
                route="{{route}}"
                pattern="/load/:loadPath"
                data="{{loadPathData}}">
        </app-route>

        <app-route
                route="{{route}}"
                pattern="/save/:savePath"
                data="{{savePathData}}">
        </app-route>

        <div class="toolbar">
            <input type="text" id="file-path">
            <button id="load-button">Load</button>
            <button id="save-button">Save</button>
        </div>
        <editor-code id="code"></editor-code>
        <editor-stage id="stage"></editor-stage>
    </template>
    <script>
        Polymer({
            is: 'looop-editor',
            properties: {
                filePath: {
                    type: String
                },
                code: {
                    type: String
                },
                dependencies: {
                    type: Array
                },
                route: {
                    type: Object
                },
                tail: {
                    type: Boolean
                },
                loadPathData: {
                    type: Object
                },
                savePathData: {
                    type: Object
                }
            },
            listeners: {
                'load-button.tap': '_loadAction',
                'save-button.tap': '_saveAction'
            },
            observers: [
                '_onLoadPathChanged(loadPathData)',
                '_onSavePathChanged(savePathData)',
                '_viewChanged(actionData.view)'
            ],
            _onLoadPathChanged: function (data) {
                if(data.loadPath) {
                    console.log('Load ', data.loadPath);
                    this._load(data.loadPath.replace(/^\/+/g, ''));
                }
            },
            _onSavePathChanged: function (data) {
                if(data.savePathData) {
                    console.log('Save ', data.savePath);
                    this._save(data.savePath.replace(/^\/+/g, ''));
                }
            },
            _load: function(filePath) {
                let headers = new Headers();
                headers.append('Content-Type', 'application/json');
                let opts = {
                    headers: headers,
                    method: "GET"
                };
                let that = this;
                fetch(
                        filePath,
                        opts)
                        .then(function (response) {
                            return response.text();
                        })
                        .then(function (response) {
//                            console.log(response);
                            that.$['file-path'].value = filePath;
                            that.$['code'].fire('code', response);
                            that.$['stage'].fire('code', {
                                code: response
                            })
                        })
                        .catch(function (error) {
                            console.error(error);
                            that.fire('error', error);
                        });
            },
            _save: function() {
                console.log('save');
                let content = this.$.code.getCode();
                let filePath = this.$['file-path'].value;
                let headers = new Headers();
                headers.append('Content-Type', 'application/json');
                let reqBody = {
                    code: content,
                    filePath: filePath
                };
                let opts = {
                    headers: headers,
                    method: "PUT",
                    body: JSON.stringify(reqBody)
                };
                let that = this;
                fetch(
                        window.location.protocol + '//' + window.location.hostname + ':3001' + '/api/file',
                        opts)
                        .then(function (response) {
                            that.componentId = filePath;
                            that.fire('files-saved', response);
                            console.log(response);
                        })
                        .catch(function (error) {
                            console.error(error);
                            that.fire('error', error);
                        });
            },
            _loadAction: function (event) {
                var filePath = this.$['file-path'].value;
                this.set('loadPathData.loadPath', filePath);
            },
            _saveAction: function (event) {
                this._save();
            }
        });
    </script>
</dom-module>
